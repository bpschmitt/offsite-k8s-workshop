{
    "componentChunkName": "component---node-modules-rocketseat-gatsby-theme-docs-core-src-templates-docs-query-js",
    "path": "/exercises/06_ohis_hpa",
    "result": {"data":{"mdx":{"id":"a17876b1-3f4f-55fe-92b8-e36bc0916446","excerpt":"06. On-Host Integrations (OHIs) and Horizontal Pod Autoscaling (HPA) In this module, you will: Configure the NGINX OHI to auto-discover NGINX instances runningâ€¦","fields":{"slug":"/exercises/06_ohis_hpa/"},"frontmatter":{"title":"","description":null,"image":null,"disableTableOfContents":null},"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h2\", {\n    \"id\": \"06-on-host-integrations-ohis-and-horizontal-pod-autoscaling-hpa\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#06-on-host-integrations-ohis-and-horizontal-pod-autoscaling-hpa\",\n    \"aria-label\": \"06 on host integrations ohis and horizontal pod autoscaling hpa permalink\",\n    \"className\": \"anchor before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"06. On-Host Integrations (OHIs) and Horizontal Pod Autoscaling (HPA)\"), mdx(\"p\", null, \"In this module, you will:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Configure the NGINX OHI to auto-discover NGINX instances running in the cluster\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Enable the custom metrics adapter for HPA and configured a custom metric (\", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"nginx_average_requests\"), \" for auto-scaling)\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Create the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"nginx-scaler\"), \" HPA resource\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Generate load to the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"nginx\"), \" service in order to trigger the auto-scaling process\")), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Reading\"), \":\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Learn about the \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/\"\n  }, \"Horizontal Pod Autoscaler\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Learn about options when running \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://helm.sh/docs/helm/helm_upgrade/\"\n  }, \"helm upgrade\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"NGINX OHI config \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://github.com/newrelic/nri-nginx/blob/master/nginx-config.yml.k8s_sample\"\n  }, \"examples\"))), mdx(\"hr\", null), mdx(\"p\", null, \"New Relic's On-Host Integrations use \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/newrelic/nri-discovery-kubernetes\"\n  }, \"Kubernetes service auto-discovery\"), \" to identify available 3rd party services running in the cluster.  All supported OHIs are shipped with the New Relic Infrastructure agent in a Kubernetes cluster.  All you need to do is provided a valid configuration when you install the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"newrelic-infrastructure\"), \" subchart.\"), mdx(\"h2\", {\n    \"id\": \"enabling-the-nginx-ohi\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#enabling-the-nginx-ohi\",\n    \"aria-label\": \"enabling the nginx ohi permalink\",\n    \"className\": \"anchor before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Enabling the NGINX OHI\"), mdx(\"p\", null, \"In the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"values.yaml\"), \" file found in this directory, you'll see a section of the config called \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"newrelic-infrastructure\"), \".  Any configuration options defined in this section are passed down to the the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"newrelic-infrastructure\"), \" subchart from \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"nri-bundle\"), \".  Uncomment the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"newrelic-infrastructure\"), \" section and everything nested underneath it.\"), mdx(\"p\", null, \"A few things to call out:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"name\"), \" - this is the integration file name that will reside in \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"/etc/newrelic-infra/integrations.d\"), \" inside each New Relic Infrastructure container.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"nri-discovery-kubernetes\"), \" - this is used to auto-discover the services in the cluster matching the label \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"app: nginx\"), \".\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"integrations\"), \" - this is where you configure the integration details.  Note that the variable \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"${discovery.ip}\"), \" is used in the NGINX status page URL.  This is dynamic for every instance that matches the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"app: nginx\"), \" label.\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"newrelic-infrastructure:\\n  integrations_config:\\n    - name: nri-nginx.yaml\\n      data:\\n        discovery:\\n          command:\\n            # Use the following optional arguments:\\n            # --namespaces: Comma separated list of namespaces to discover pods on\\n            # --tls: Use secure (TLS) connection\\n            # --port: Port used to connect to the kubelet. Default is 10255\\n            exec: /var/db/newrelic-infra/nri-discovery-kubernetes\\n            match:\\n              label.app: nginx\\n        integrations:\\n          - name: nri-nginx\\n            env:\\n              # If you're using ngx_http_api_module be certain to use the full path up to and including the version number\\n              # Use the discovered IP as the host address\\n              STATUS_URL: http://${discovery.ip}/nginx_status\\n              # Name of Nginx status module OHI is to query against. discover | ngx_http_stub_status_module | ngx_http_status_module | ngx_http_api_module\\n              STATUS_MODULE: discover\\n              METRICS: 1\\n              REMOTE_MONITORING: 1\\n\")), mdx(\"h2\", {\n    \"id\": \"custom-metrics-adapter-for-horizontal-pod-autoscaling\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#custom-metrics-adapter-for-horizontal-pod-autoscaling\",\n    \"aria-label\": \"custom metrics adapter for horizontal pod autoscaling permalink\",\n    \"className\": \"anchor before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Custom Metrics Adapter for Horizontal Pod Autoscaling\"), mdx(\"p\", null, mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/newrelic/helm-charts/tree/master/charts/newrelic-k8s-metrics-adapter\"\n  }, \"New Relic's Kubernetes Metric Adapter\"), \" enables developers to scale their deployments using the Kubernetes \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/\"\n  }, \"Horizontal Pod Autoscaler\"), \".  Imagine needing to dynamically scale your services to support an increase in throughput during your biggest day?  With the metric adapter, you can now query New Relic using NRQL and use the value returned for evaluation within HPA.\"), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"https://docs.newrelic.com/550f34a8085779979e628c68bc885d1a/adapter-diagram.svg\",\n    \"alt\": \"Image\"\n  })), mdx(\"p\", null, \"In the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"values.yaml\"), \" file in this directory, uncomment the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"newrelic-k8s-metrics-adapter\"), \" section and everything nested underneath it.  You'll need to provide the following:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"personalAPIKey\"), \" - this is NOT a license key.  This is a User API key.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"accountID\"), \" - this is the New Relic Account ID to query.\")), mdx(\"p\", null, \"The metric adapter uses the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://docs.newrelic.com/docs/apis/nerdgraph/get-started/introduction-new-relic-nerdgraph/\"\n  }, \"Nerdgraph API\"), \" to query New Relic using NRQL.  In the example, you'll be creating a custom metric to be stored in Kubernetes called \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"nginx_average_requests\"), \" and the value for this metric will be the result of the supplied NRQL query.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"newrelic-k8s-metrics-adapter:\\n  personalAPIKey: <REDACTED>\\n  config:\\n    accountID: <REDACTED>\\n    externalMetrics:\\n      nginx_average_requests:\\n        query: \\\"from Metric select average(nginx.server.net.requestsPerSecond) since 2 minutes ago\\\"\\n\")), mdx(\"h2\", {\n    \"id\": \"upgrading-the-newrelic-bundle-helm-release\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#upgrading-the-newrelic-bundle-helm-release\",\n    \"aria-label\": \"upgrading the newrelic bundle helm release permalink\",\n    \"className\": \"anchor before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Upgrading the \", mdx(\"inlineCode\", {\n    parentName: \"h2\"\n  }, \"newrelic-bundle\"), \" Helm release\"), mdx(\"p\", null, \"Now that you've modified your \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"values.yaml\"), \" for both the NGINX OHI and the metrics adapter, it's time to upgrade the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"newrelic-bundle\"), \" release with the new configuration.\"), mdx(\"p\", null, \"You'll notice this command is a lot shorter than the original one from the Guided Install UI.  That's because you're upgrading an existing release and you've moved all configuration to a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"values.yaml\"), \" file. A couple new options are being used for the \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://helm.sh/docs/helm/helm_upgrade/\"\n  }, \"helm upgrade\"), \":\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"--reuse-values\"), \" - when upgrading, reuse the last release's values and merge in any overrides from the command line via \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"--set\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"-f\"), \".\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"-f\"), \" - specify values in a YAML file or a URL (can specify multiple)\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"$ helm upgrade newrelic-bundle newrelic/nri-bundle -n newrelic --reuse-values -f ./values.yaml\\nRelease \\\"newrelic-bundle\\\" has been upgraded. Happy Helming!\\nNAME: newrelic-bundle\\nLAST DEPLOYED: Tue Nov  9 21:46:03 2021\\nNAMESPACE: newrelic\\nSTATUS: deployed\\nREVISION: 7\\nTEST SUITE: None\\n\")), mdx(\"p\", null, \"You can run a quick validation using NRQL that the NGINX OHI has been configured successfully.  You should see rows returned in query builder.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"FROM NginxSample select podName, net.connectionsActive where clusterName = 'minikube-workshop'\\n\")), mdx(\"h2\", {\n    \"id\": \"create-nginx-scaler-hpa-resource\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#create-nginx-scaler-hpa-resource\",\n    \"aria-label\": \"create nginx scaler hpa resource permalink\",\n    \"className\": \"anchor before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Create \", mdx(\"inlineCode\", {\n    parentName: \"h2\"\n  }, \"nginx-scaler\"), \" HPA resource\"), mdx(\"p\", null, \"Congrats! You've configured the NGINX OHI and the custom metrics adapter.  Now it's time to create the HPA resource in your cluster so that your NGINX deployment will autoscale based on metric data that exists in New Relic.\"), mdx(\"p\", null, \"Let's take a look at the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"hpa.yaml\"), \" file.  In this file, you're creating a custom metric called \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"nginx_average_requests\"), \" which is created and stored in Kubernetes.  Kubernetes will auto-scale the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"nginx\"), \" deployment up or down so that the value returned by the NRQL query is below the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"target.value\"), \" of \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"2\"), \".\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"kind: HorizontalPodAutoscaler\\napiVersion: autoscaling/v2beta2\\nmetadata:\\n  name: nginx-scaler\\n  namespace: demo\\nspec:\\n  scaleTargetRef:\\n    apiVersion: apps/v1\\n    kind: Deployment\\n    name: nginx\\n  minReplicas: 1\\n  maxReplicas: 10\\n  metrics:\\n    - type: External\\n      external:\\n        metric:\\n          name: nginx_average_requests\\n          selector:\\n            matchLabels:\\n              k8s.namespaceName: demo\\n        target:\\n          type: Value\\n          value: 2\\n  behavior:\\n    scaleDown:\\n      stabilizationWindowSeconds: 90\\n    scaleUp:\\n      stabilizationWindowSeconds: 90\\n\")), mdx(\"p\", null, \"You can query the Kubernetes API directly to see the values being evaluated.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"$ kubectl get --raw \\\"/apis/external.metrics.k8s.io/v1beta1/namespaces/*/nginx_average_requests?labelSelector=k8s.namespaceName=demo\\\"\\n\\n{\\\"kind\\\":\\\"ExternalMetricValueList\\\",\\\"apiVersion\\\":\\\"external.metrics.k8s.io/v1beta1\\\",\\\"metadata\\\":{},\\\"items\\\":[{\\\"metricName\\\":\\\"nginx_average_requests\\\",\\\"metricLabels\\\":{},\\\"timestamp\\\":\\\"2021-11-10T04:25:00Z\\\",\\\"value\\\":\\\"33333u\\\"}]}\\n\")), mdx(\"p\", null, \"Run the following command to create the HPA resource in your cluster.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"$ kubectl apply -f hpa.yaml -n demo\\n\")), mdx(\"p\", null, \"Validate that it was created and note the existing values under the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"TARGETS\"), \" section.  Kubernetes uses \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"milliunits\"), \" so you'll see strange numbers like \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"3400m\"), \" show up here.  For illustration purposes, this means \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"3400 / 1000 = 3.4\"), \".\"), mdx(\"p\", null, \"Keep this command handy, you'll come back to it.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"$ kubectl get hpa nginx-scaler -n demo\\nNAME           REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE\\nnginx-scaler   Deployment/nginx   34m/2     1         10        1          15m\\n\")), mdx(\"h2\", {\n    \"id\": \"generate-load\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#generate-load\",\n    \"aria-label\": \"generate load permalink\",\n    \"className\": \"anchor before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Generate Load\"), mdx(\"p\", null, \"Now that you've configured the NGINX OHI, configured the metrics adapter, and created the HPA resource - it's time to watch the magic happen.  Use the command below to create a load generation pod in your cluster which will hit the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"nginx\"), \" service endpoint with a bunch of curl commands.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"$ kubectl apply -f loadgen.yaml -n demo\\npod/load-gen created\\n\")), mdx(\"p\", null, \"Immediately after starting your load gen, run this command to watch the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"nginx-scaler\"), \" HPA resource as it scales up your \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"nginx\"), \" deployment.\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"$ kubectl get hpa -n demo -w\\nNAME           REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE\\nnginx-scaler   Deployment/nginx   34m/2     1         10        1          40m\\nnginx-scaler   Deployment/nginx   192m/2    1         10        1          40m\\nnginx-scaler   Deployment/nginx   1367m/2   1         10        1          40m\\nnginx-scaler   Deployment/nginx   2534m/2   1         10        1          41m\\nnginx-scaler   Deployment/nginx   3709m/2   1         10        1          41m\\nnginx-scaler   Deployment/nginx   4717m/2   1         10        1          42m\\nnginx-scaler   Deployment/nginx   4717m/2   1         10        2          42m\\nnginx-scaler   Deployment/nginx   4209m/2   1         10        2          43m\\nnginx-scaler   Deployment/nginx   4209m/2   1         10        2          43m\\nnginx-scaler   Deployment/nginx   2467m/2   1         10        3          44m\\nnginx-scaler   Deployment/nginx   2467m/2   1         10        4          44m\\nnginx-scaler   Deployment/nginx   1880m/2   1         10        4          44m\\n\")), mdx(\"p\", null, \"You can watch this process visually by creating a multi-query chart in New Relic's query builder with the following NRQL queries:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"from Metric select average(nginx.server.net.requestsPerSecond) where k8s.namespaceName = 'demo' since 30 minutes ago TIMESERIES 30 seconds\\n\")), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"FROM K8sPodSample select uniqueCount(podName) as 'Pod Count' where podName like 'nginx%' since 30 minutes ago TIMESERIES 30 seconds\\n\")), mdx(\"p\", null, \"Here you can see as the average throughput increases, HPA kicks in and scales the deployment until the average throughput is below the target value of 2.\"), mdx(\"p\", null, mdx(\"img\", {\n    parentName: \"p\",\n    \"src\": \"https://p191.p3.n0.cdn.getcloudapp.com/items/DOu6mbWZ/68c68579-6c95-4940-8a88-923c2f607bb9.jpg?v=8db29e4462645dc093dbc5f445752972\",\n    \"alt\": \"Autoscale\"\n  })), mdx(\"h2\", {\n    \"id\": \"conclusion\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#conclusion\",\n    \"aria-label\": \"conclusion permalink\",\n    \"className\": \"anchor before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Conclusion\"), mdx(\"p\", null, \"In this module, you completed the following:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Configured the NGINX OHI to auto-discover NGINX instances running in the cluster\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Enabled the custom metrics adapter for HPA and configured a custom metric (\", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"nginx_average_requests\"), \" for auto-scaling)\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Created the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"nginx-scaler\"), \" HPA resource\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Generated load to the \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"nginx\"), \" service in order to trigger the auto-scaling process\")));\n}\n;\nMDXContent.isMDXComponent = true;","headings":[{"depth":2,"value":"06. On-Host Integrations (OHIs) and Horizontal Pod Autoscaling (HPA)"},{"depth":2,"value":"Enabling the NGINX OHI"},{"depth":2,"value":"Custom Metrics Adapter for Horizontal Pod Autoscaling"},{"depth":2,"value":"Upgrading the newrelic-bundle Helm release"},{"depth":2,"value":"Create nginx-scaler HPA resource"},{"depth":2,"value":"Generate Load"},{"depth":2,"value":"Conclusion"}]}},"pageContext":{"slug":"/exercises/06_ohis_hpa/","prev":{"label":"Promethus OpenMetrics Integration","link":"/exercises/05_pomi"},"next":{"label":"Logging","link":"/exercises/07_logging"},"repositoryEditUrl":"https://github.com/jpedroschmitz/rocketdocs/tree/main/examples/gatsby-theme-docs/src/docs/exercises/06_ohis_hpa.mdx","repositoryProvider":"GitHub"}},
    "staticQueryHashes": ["1954253342","2328931024","2501019404","973074209"]}